---
title: Core API Guide
---

# Hardware SDK Core API Guide

Single-page deep guide for integrators: behavior model of core APIs + params/events/safety/error handling. `Getting Started` is for “5-minute first call”; this page is for production-ready, maintainable integration.

## Compatibility & prerequisites

- SDK set: `@onekeyfe/hd-common-connect-sdk` + `@onekeyfe/hd-core` + `@onekeyfe/hd-shared`; keep versions aligned with firmware/Bridge releases.
- Runtime env:
  - `webusb`: HTTPS + user gesture; browser must support WebUSB.
  - `react-native`: BLE permission and often location permission; ensure Bluetooth is on.
  - `lowlevel`: custom transport adapter that supports 64-byte frames.
- Device/firmware: stay on the latest stable; API calls may fail in Bootloader mode.
- Bridge (if used): match SDK version; ensure it’s running and port is free.

## Lifecycle & concurrency

Standard loop: `init → discover → identify(deviceId) → subscribe events → call + uiResponse → optional cleanup`

```ts
import HardwareSDK, { UI_EVENT, UI_REQUEST, UI_RESPONSE } from '@onekeyfe/hd-common-connect-sdk';

// 1) idempotent init, usually once at app start
await HardwareSDK.init({ env: 'webusb', fetchConfig: true, debug: false });

// 2) discover devices
const devices = await HardwareSDK.searchDevices();
if (!devices.length) throw new Error('No device');
const [{ connectId }] = devices;

// 3) resolve deviceId (required for BLE; recommended for WebUSB)
const features = await HardwareSDK.getFeatures(connectId);
const deviceId = features?.payload?.device_id;

// 4) subscribe UI events and call uiResponse in callbacks
HardwareSDK.on(UI_REQUEST.REQUEST_PIN, () => {
  // open UI, collect input, then call uiResponse
});
HardwareSDK.on(UI_REQUEST.REQUEST_PASSPHRASE, () => {});

// 5) make a chain call (EVM example)
await HardwareSDK.evmSignTransaction(connectId, deviceId, {
  path: "m/44'/60'/0'/0/0",
});
```

## connectId vs deviceId

- `connectId`: the **connection identifier** (transport-level). It tells the SDK “which device/connection to talk to”, and its format depends on the current environment/transport.
  - USB/WebUSB/Bridge: usually the device serial number (from firmware `Features.onekey_serial_no` / `onekey_serial` / `serial_no`).
  - BLE: usually the OS-level identifier (commonly MAC on Android; UUID on iOS; may be a BLE UUID on desktop).
- `deviceId`: the **current seed/wallet-state identifier** from firmware `Features.device_id`, resolved via `getFeatures(connectId)`.
  - It changes after device wipe / recovery / seed replacement; it is not the hardware serial number.
  - The SDK may validate it for sensitive calls (`checkDeviceId` on some methods) to prevent signing on a device whose seed has changed while you keep using the same `connectId`.
- Practice: keep `connectId` + `deviceId` as a pair in memory; on `DeviceCheckDeviceIdError` or after a reset, rerun `getFeatures(connectId)` and ask the user to confirm the device state.

- Concurrency: keep calls serial per device to avoid PIN/Passphrase deadlocks.
- Reuse: combine `keepSession + passphraseState` to reduce prompts; on device switch, refresh `getFeatures`.
- Cleanup: when a page is disposed, remove listeners; call `HardwareSDK.dispose()` only if you need to reset transport state.

## 通用参数速查（CommonParams）

| Param | Purpose | Typical usage |
| --- | --- | --- |
| `initSession?: boolean` | Force a hardware session init; can pair with passphrase state retrieval | Pre-build session before first call to reduce prompts |
| `passphraseState?: string` | Hidden wallet identifier; include to bind to that hidden wallet | Required when using a hidden wallet to stay on the same one |
| `useEmptyPassphrase?: boolean` | Force standard wallet (empty) | Prevent accidental hidden wallet |
| `deriveCardano?: boolean` | Pre-derive Cardano | First Cardano call in a session |
| `retryCount?` / `pollIntervalTime?` / `timeout?` | Polling/timeout tuning | BLE or flaky network scenarios |
| `detectBootloaderDevice?: boolean` | Fail fast in Bootloader | Ask user to exit Bootloader |
| `skipWebDevicePrompt?: boolean` | Skip WebUSB chooser | Reuse prior WebUSB authorization |
| `keepSession?` | (Deprecated; avoid using) | Use `initSession + passphraseState` instead |

Common combos:

```ts
// Hidden wallet + multiple calls without repeated prompts
const commonParams = {
  initSession: true,
  keepSession: true,
  passphraseState: 'hidden-wallet-id',
};

await HardwareSDK.evmSignMessage(connectId, deviceId, {
  path: "m/44'/60'/0'/0/0",
  messageHex,
  ...commonParams,
});
```

## HD Path 与账户选择

- Rule: `path: string | number[]` follows BIP44; ed25519 chains (e.g., Solana, NEAR) must be fully hardened.
- Common paths:

| Chain | Example path | Notes |
| --- | --- | --- |
| EVM | `m/44'/60'/0'/0/0` | Standard EVM account |
| BTC (Nested SegWit) | `m/49'/0'/0'/0/0` | Use 84' for Native SegWit |
| Solana | `m/44'/501'/0'/0'` | Fully hardened |
| NEAR | `m/44'/397'/0'/0'/1'` | Fully hardened |
| Cardano | `m/1852'/1815'/0'/0/0` | Stake at `.../2/0` |
| TRON | `m/44'/195'/0'/0/0` | EVM-style path |

- Number array example: `[(44 | 0x80000000) >>> 0, (0 | 0x80000000) >>> 0, 0x80000000, 0, 0]`
- Forbidden path errors: verify length/hardening per chain; see chain-specific pages in the sidebar.

## 事件与 UI 响应

**Quick flow (numbered for scanability)**  
1) Subscribe `UI_EVENT`.  
2) Check type.  
3) Call `uiResponse` only when required.  
4) Unsubscribe on page exit.

**Need-response (UI_REQUEST → UI_RESPONSE)**  
5) PIN: `REQUEST_PIN` → `RECEIVE_PIN`。  
6) Passphrase: `REQUEST_PASSPHRASE` / `REQUEST_PASSPHRASE_ON_DEVICE` → `RECEIVE_PASSPHRASE`（`payload` supports `passphraseOnDevice` / `attachPinOnDevice` / `save`）。  
7) Web Bootloader select: `REQUEST_DEVICE_IN_BOOTLOADER_FOR_WEB_DEVICE` → `SELECT_DEVICE_IN_BOOTLOADER_FOR_WEB_DEVICE`（return `deviceId`）。

**Display-only (no `uiResponse`)**  
8) `REQUEST_BUTTON`、`DEVICE_PROGRESS`、`FIRMWARE_PROCESSING` / `FIRMWARE_PROGRESS` / `FIRMWARE_TIP`、`BLUETOOTH_PERMISSION` / `LOCATION_PERMISSION`、`BOOTLOADER` / `REQUIRE_MODE` / `NOT_INITIALIZE` / `FIRMWARE_NOT_SUPPORTED` 等。

**Device/Firmware watch**  
9) `DEVICE_EVENT`: lifecycle (`CONNECT`/`DISCONNECT`/`ACQUIRE`/`RELEASE`/`CHANGED`/`USED_ELSEWHERE`/`UNREADABLE`), interaction (`BUTTON`/`PIN`/`PASSPHRASE`/`PASSPHRASE_ON_DEVICE`/`SELECT_DEVICE_IN_BOOTLOADER_FOR_WEB_DEVICE`), capability (`FEATURES`/`SUPPORT_FEATURES`)。  
10) `FIRMWARE_EVENT`: `RELEASE_INFO`、`BLE_RELEASE_INFO`。

**Response rules**  
11) Only call `uiResponse` after the matching `UI_REQUEST`；on cancel/timeout, tell the user and decide whether to rerun；cleanup with `HardwareSDK.off` / `removeAllListeners` when leaving.

**Minimal wiring**

```ts
import HardwareSDK, { UI_EVENT, UI_REQUEST, UI_RESPONSE } from '@onekeyfe/hd-common-connect-sdk';

const handleUiEvent = (msg: any) => {
  switch (msg.type) {
    case UI_REQUEST.REQUEST_PIN:
      openPinModal(({ value }) =>
        HardwareSDK.uiResponse({ type: UI_RESPONSE.RECEIVE_PIN, payload: value })
      );
      return;
    case UI_REQUEST.REQUEST_PASSPHRASE:
      openPassphraseModal(({ value, onDevice, save }) =>
        HardwareSDK.uiResponse({
          type: UI_RESPONSE.RECEIVE_PASSPHRASE,
          payload: { value, passphraseOnDevice: onDevice, attachPinOnDevice: false, save },
        })
      );
      return;
    case UI_REQUEST.REQUEST_DEVICE_IN_BOOTLOADER_FOR_WEB_DEVICE:
      showDeviceList((deviceId: string) =>
        HardwareSDK.uiResponse({
          type: UI_RESPONSE.SELECT_DEVICE_IN_BOOTLOADER_FOR_WEB_DEVICE,
          payload: { deviceId },
        })
      );
      return;
    default:
      console.log('UI event', msg.type, msg.payload);
  }
};

HardwareSDK.on(UI_EVENT, handleUiEvent);
```

## PIN 与 Passphrase 安全策略

- PIN: Pro/Touch require on-device input; others support blind PIN but on-device is preferred.

```ts
const BLIND_KEYBOARD_MAP = ['7', '8', '9', '4', '5', '6', '1', '2', '3'];
HardwareSDK.uiResponse({
  type: UI_RESPONSE.RECEIVE_PIN,
  payload: BLIND_KEYBOARD_MAP[label - 1],
});
```

- Passphrase: standard wallet = default empty passphrase; hidden wallet = non-empty (case-sensitive).
  - Most secure: `passphraseOnDevice: true`
  - Software input: `{ value, passphraseOnDevice: false, save: true }` is session-only; never persist plaintext.
  - Avoid accidental hidden wallet: add `useEmptyPassphrase: true` in method params.

## 错误码到行动（示例归类）

| Group | Common causes | Recommended actions |
| --- | --- | --- |
| Device (101–118, 200) | Wrong mode, busy, device_id mismatch, not initialized | Ask user to confirm device mode, reconnect, re-run `init` + `getFeatures` |
| IFrame (300–305) | Init missing, load/timeout/blocked | Ensure `init` succeeded and CSP/iframe allow it |
| Method/Firmware (400–418) | Bad params, firmware upgrade required, forbidden path | Validate params/HD path, prompt firmware upgrade |
| Transport (600–603) | Transport not configured, concurrent call, protobuf error | Check env/Bridge, serialize calls, align SDK version |
| Bluetooth (700–722) | Scan/permission/connect/timeout | Ensure BLE/location permission, proximity/power, retry connect |
| Runtime/Bridge (800–821) | PIN/action cancelled, Bridge permission/timeout, blind sign disabled | Retry, ask to install/start Bridge, ensure signing mode |
| Web device (901–902) | WebUSB/Bluetooth not authorized or chooser failure | Ask user to re-authorize; ensure HTTPS + user gesture |

Pattern: map error → user message + developer action; provide UI buttons for retry/check device/upgrade firmware.

## 快速检查清单

1) Init once; confirm env/permissions/HTTPS; keep `connectId` + `deviceId`  
2) Subscribe UI/DEVICE/FIRMWARE; send `uiResponse` only after events  
3) Serialize per device; combine CommonParams (keepSession/passphraseState)  
4) Use valid HD paths; if errors, check chain docs and hardening rules  
5) Map error codes to user text and dev actions; prompt firmware/Bridge updates when needed  

## 相关链接

- Getting Started（install + first call）：[quick start](/en/hardware-sdk/getting-started)
- Transports: WebUSB · React Native BLE · iOS/Android low-level adapters
- Chain APIs: sidebar `sign` / `getAddress` method pages by chain
- Legacy migration: bridge-to-common-connect/WebUSB migration guides
