---
slug: /hardware/transport/native-ble
---

# 原生蓝牙（底层适配器和协议）

在 iOS/Android/Flutter 原生宿主中，我们建议使用 `@onekeyfe/hd-common-connect-sdk` 的 `lowlevel` 适配器，这样您可以复用与 Web 路径完全相同的 SDK API。JS 保持不变；只有传输适配器将调用转发到原生层进行 BLE/USB I/O。

## 适配器契约（JS ↔ 原生）

```ts
import HardwareSDK from '@onekeyfe/hd-common-connect-sdk';

type LowLevelAdapter = {
  enumerate: () => Promise<Array<{ id: string; name: string }>>; // 扫描并返回设备列表
  connect: (id: string) => Promise<void>;                         // 打开连接并设置监听器
  disconnect: (id: string) => Promise<void>;                      // 关闭连接并清理
  send: (id: string, data: string) => Promise<void>;              // 发送十六进制编码的数据
  receive: () => Promise<string>;                                 // 接收一帧（十六进制）；JS 重组完整消息
  init?: () => Promise<void>;                                     // 可选的适配器初始化
  version: string;
};

const adapter: LowLevelAdapter = { /* ... */ };
await HardwareSDK.init({ env: 'lowlevel', debug: true, fetchConfig: true }, undefined, adapter);
```

- JS 组装/拆解 64 字节帧（参见协议）。
- `enumerate` 返回的 `id` 被 `connect/send/disconnect` 用作连接键。

## 协议（必读）

- 传输使用 64 字节数据包：[OneKey 消息协议](./onekey-message-protocol)
- 默认 BLE UUID（过滤和绑定）：
  - `serviceUuid`: `00000001-0000-1000-8000-00805f9b34fb`
  - `writeCharacteristic`: `00000002-0000-1000-8000-00805f9b34fb`
  - `notifyCharacteristic`: `00000003-0000-1000-8000-00805f9b34fb`

## 平台说明

### iOS（CoreBluetooth + WKWebView）
- 在加载 `index.html` 之前初始化桥接（如 `WKWebViewJavascriptBridge`）。
- 注册 `enumerate/connect/send/monitorCharacteristic` 处理程序。
- 按 `serviceUuid` 过滤扫描；连接后缓存 `CBPeripheral` 和特征。
- 将 64 字节通知以十六进制形式转发给 JS；JS 为 `receive()` 重组完整负载。
- 通过原生 UI 呈现 PIN/确认提示，并使用 `HardwareSDK.uiResponse` 响应。

### Android（WebView + Nordic BLE）
- 使用 `com.smallbuer:jsbridge` 作为消息桥接；在较新系统上 JS 引擎是可选的。
- 在 Android 12+ 上请求 `BLUETOOTH_SCAN/BLUETOOTH_CONNECT` 和位置权限。
- 按 `serviceUuid` 过滤扫描；持久化 `Gatt` 并映射 `connect/disconnect/send`。
- 缓冲通知块然后转发给 JS 接收器。
- 可选 USB 支持：在 `enumerate` 中按白名单过滤。

### Flutter
- 选择 `flutter_js` 或 WebView；复用相同的桥接 + 帧逻辑。
- 按照演示的打包流程处理 web 资源。

工作示例（本文档）：
- iOS：[iOS — 通过蓝牙连接](./ios)
- Android：[Android — 通过蓝牙连接](./android)
- React Native（BLE）：[React Native 蓝牙](../react-native-ble)
  - 以及 [事件配置](../../api-reference/config-event)


## 通用提示

- 尽早订阅 `UI_EVENT`，以免错过 PIN/Passphrase/确认流程。
- 首次连接后，调用 `getFeatures(connectId)` 并持久化 `device_id`。
