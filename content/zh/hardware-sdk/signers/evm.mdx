---
title: EVM Signer
---

# EVM Signer

EVM ç¡¬ä»¶ç­¾åå…¨é“¾è·¯æŒ‡å—ï¼ˆOneKey ç‰ˆï¼‰ï¼ŒåŸºäº @onekeyfe/hd-core çš„èƒ½åŠ›ï¼Œè¦†ç›–åœ°å€ç¡®è®¤ã€EIPâ€‘1559 / Legacy äº¤æ˜“ã€personal_signã€EIPâ€‘712 / EIPâ€‘7702 ç­‰åœºæ™¯ã€‚æ–‡æ¡£åŒè¯­å‘ˆç°ï¼Œä¾¿äºé›†æˆè€…å¯¹ç…§ä½¿ç”¨ã€‚

## ğŸ”¹ Index / ç›®å½•

1. [How it works / å·¥ä½œåŸç†](#-how-it-works--å·¥ä½œåŸç†)
2. [Installation / å®‰è£…](#-installation--å®‰è£…)
3. [Initialisation / åˆå§‹åŒ–](#-initialisation--åˆå§‹åŒ–)
4. [Use Cases / ç”¨ä¾‹](#-use-cases--ç”¨ä¾‹)
   - [Get Address](#use-case-1-get-address)
   - [Sign Transaction (1559 / Legacy)](#use-case-2-sign-transaction)
   - [Sign Message (personal_sign)](#use-case-3-sign-message)
   - [Sign Typed Data (EIP-712)](#use-case-4-sign-typed-data)
   - [Sign Delegation Authorization (EIP-7702)](#use-case-5-sign-delegation-authorization-eip-7702)
5. [äº¤äº’ä¸çŠ¶æ€](#-äº¤äº’ä¸çŠ¶æ€)
6. [Examples / ç¤ºä¾‹](#-examples--ç¤ºä¾‹)
7. [Validation & Troubleshooting / éªŒç­¾ä¸æ’éšœ](#-validation--troubleshooting--éªŒç­¾ä¸æ’éšœ)

## ğŸ”¹ How it works / å·¥ä½œåŸç†

The EVM signer talks to the OneKey hardware app through `HardwareSDK`ï¼Œå†…éƒ¨ä½¿ç”¨ APDU å®Œæˆè®¾å¤‡äº¤äº’ï¼Œå¤–éƒ¨ä»¥ç‹¬ç«‹ç”¨ä¾‹æš´éœ²ï¼ˆåœ°å€ã€äº¤æ˜“ã€æ¶ˆæ¯ã€Typed Dataã€æˆæƒï¼‰ã€‚æ¥å£ä»¥ Promise `{ success, payload }` è¿”å›ç»“æœï¼Œäº¤äº’æç¤ºé€šè¿‡ `UI_REQUEST` äº‹ä»¶è§¦å‘ï¼ˆPINã€å¯†ç çŸ­è¯­ã€æ‰“å¼€ Appã€ç¡®è®¤åœ°å€/äº¤æ˜“/æ¶ˆæ¯/Typed Data/æˆæƒï¼‰ã€‚

EVM ç­¾åçš„åŸºæœ¬é“¾è·¯ï¼š

1) ä¸»æœºä¾§æ„é€ å‚æ•°ï¼ˆè·¯å¾„ã€äº¤æ˜“/æ¶ˆæ¯æ•°æ®ã€chainId ç­‰ï¼‰ã€‚  
2) SDK å»ºç«‹ä¼šè¯å¹¶å‘é€å‘½ä»¤ï¼Œè®¾å¤‡è¿›å…¥å®¡é˜…æµç¨‹ã€‚  
3) è®¾å¤‡æ˜¾ç¤ºè·¯å¾„ã€åœ°å€ã€é‡‘é¢ã€Gasã€ChainIdã€æ¶ˆæ¯æ‘˜è¦æˆ– Typed Data åŸŸã€‚  
4) ç”¨æˆ·ç¡®è®¤åè¿”å›ç­¾å `{ r, s, v }` æˆ–åå…­è¿›åˆ¶ç­¾åã€‚  
5) ä¸»æœºä½¿ç”¨ `ethers` / `viem` è¿›è¡Œåºåˆ—åŒ–ã€éªŒç­¾å¹¶å¹¿æ’­ã€‚

> ä¸­æ–‡æ€è·¯ï¼šæŠŠâ€œèƒ½è·‘ã€çœ‹å¾—æ‡‚ã€èƒ½éªŒç­¾â€ä½œä¸ºé¦–è¦ç›®æ ‡ï¼Œä»»ä½•å­—æ®µéƒ½ä»¥é“¾ä¸Šå¹¿æ’­ä¸è®¾å¤‡æ˜¾ç¤ºä¸€è‡´ä¸ºå‡†ã€‚

## ğŸ”¹ Installation / å®‰è£…

> æœ¬æ¨¡å—ä¾èµ– `@onekeyfe/hd-core` åŠè¿æ¥å±‚ï¼ˆå¦‚ `@onekeyfe/hd-common-connect-sdk`ï¼‰ï¼Œè¯·å…ˆå®ŒæˆåŸºç¡€ SDK å®‰è£…ã€‚

```bash
npm install @onekeyfe/hd-core @onekeyfe/hd-common-connect-sdk
```

## ğŸ”¹ Initialisation / åˆå§‹åŒ–

```ts
import HardwareSDK from '@onekeyfe/hd-core';
// æˆ–ä½¿ç”¨ connect-sdk å°è£…çš„ HardwareSDK

await HardwareSDK.init({ env: 'webusb', debug: false, fetchConfig: true });

const [{ connectId }] = await HardwareSDK.searchDevices();
const deviceId = (await HardwareSDK.getFeatures(connectId)).payload?.device_id;
```

> ä¿æŒå›ºä»¶ä¸ºæœ€æ–°ç‰ˆæœ¬ï¼Œç¡®ä¿ WebUSB/BLE è¿æ¥ç¨³å®šï¼›å»ºè®®åœ¨ç­¾åå‰å…ˆå®Œæˆä¸€æ¬¡ `evmGetAddress(showOnOneKey: true)` ä»¥ç¡®è®¤è·¯å¾„ä¸è´¦æˆ·ã€‚

## ğŸ”¹ Use Cases / ç”¨ä¾‹

`evmGetAddress` / `evmSignTransaction` / `evmSignMessage` / `evmSignTypedData` / `evmSignDelegationAuthorization` äº”ä¸ªæ–¹æ³•åˆ†åˆ«å¯¹åº”ç‹¬ç«‹ç”¨ä¾‹ï¼Œè¿”å› Promise `{ success, payload }`ï¼ˆç”¨æˆ·äº¤äº’é€šè¿‡äº‹ä»¶é€šçŸ¥ï¼Œè§ä¸‹æ–‡ï¼‰ã€‚

---

### Use Case 1: Get Address

è·å–æŒ‡å®šè·¯å¾„çš„ EVM åœ°å€ï¼Œå¯é€‰æ‹©åœ¨è®¾å¤‡ä¸Šæ ¸å¯¹ã€‚

```ts
const res = await HardwareSDK.evmGetAddress(connectId, deviceId, {
  path: "m/44'/60'/0'/0/0",
  showOnOneKey: true,
  chainId: 1,
});
// res.payload.address, publicKey?, chainCode?
```

**Parameters / å‚æ•°**

- `path` (string | number[]): å¿…å¡«ï¼ŒBIP44 è·¯å¾„ï¼Œä¾‹å¦‚ `"44'/60'/0'/0/0"`ã€‚
- `showOnOneKey?` (boolean): å¯é€‰ï¼Œæ˜¯å¦åœ¨è®¾å¤‡ä¸Šå±•ç¤ºå¹¶è®©ç”¨æˆ·ç¡®è®¤åœ°å€ã€‚
- `chainId?` (number): å¯é€‰ï¼Œæ˜¾ç¤ºåœ¨è®¾å¤‡ä¸Šçš„é“¾ IDï¼Œå»ºè®®å¡«çœŸå®ç½‘ç»œã€‚

**Returns / è¿”å›**

`Promise<{ success, payload: { address, path, publicKey?, chainCode? } }>`

```ts
type GetAddressResult = {
  address: `0x${string}`;
  path: string;
  publicKey?: string;
  chainCode?: string;
};
```

---

### Use Case 2: Sign Transaction

æ”¯æŒ EIPâ€‘1559 (`type: 2`) ä¸ Legacy äº¤æ˜“ï¼Œéœ€ä¼ å…¥åºåˆ—åŒ–å‰çš„å­—æ®µã€‚

```ts
const { success, payload } = await HardwareSDK.evmSignTransaction(
  connectId,
  deviceId,
  {
    path: "m/44'/60'/0'/0/0",
    transaction: tx,
    chainId: 1,
    keepSession: true,
  },
);
// payload: { v, r, s }
```

**Parameters / å‚æ•°**

- `path` (string | number[]): å¿…å¡«ï¼Œç­¾åè·¯å¾„ã€‚
- `transaction` (object): å¿…å¡«ï¼ŒEIPâ€‘1559 æˆ– Legacy å­—æ®µï¼š
  - 1559ï¼š`to` `value` `data` `nonce` `gasLimit` `maxFeePerGas` `maxPriorityFeePerGas` `chainId` `type: 2`
  - Legacyï¼š`to` `value` `data` `nonce` `gasLimit` `gasPrice` `chainId`
- `chainId` (number): å¿…å¡«ï¼Œç½‘ç»œé“¾ IDã€‚
- `keepSession?` (boolean): å¯é€‰ï¼Œå¤šæ¬¡ç­¾åæ—¶å¤ç”¨ä¼šè¯ã€‚
- `domain?` (string): å¯é€‰ï¼Œäº¤æ˜“ä¸­çš„åŸŸåæ ‡ç­¾ï¼ˆå¦‚ ENSï¼‰ï¼Œç”¨äºè®¾å¤‡æ˜¾ç¤ºã€‚

**Returns / è¿”å›**

`Promise<{ success, payload: { v, r, s } }>`ï¼Œå¯é…åˆ `ethers/viem` åºåˆ—åŒ–ä¸º raw txã€‚

---

### Use Case 3: Sign Message (personal_sign)

```ts
const res = await HardwareSDK.evmSignMessage(connectId, deviceId, {
  path: "m/44'/60'/0'/0/0",
  messageHex,
  chainId: 1,
});
```

**Parameters / å‚æ•°**

- `path`ï¼šå¿…å¡«ï¼Œç­¾åè·¯å¾„ã€‚
- `messageHex`ï¼šå¿…å¡«ï¼ŒåŸæ–‡è½¬ hexï¼ˆä¸å« `0x` æˆ–å« `0x` çš†å¯ï¼‰ã€‚
- `chainId?`ï¼šå¯é€‰ï¼Œè®¾å¤‡æ˜¾ç¤ºçš„é“¾ IDã€‚

**Returns / è¿”å›**

`signature`ï¼ˆåå…­è¿›åˆ¶æˆ– `{ r, s, v }`ï¼‰ï¼Œå¯ç”¨ `ethers.verifyMessage` æ ¡éªŒã€‚

---

### Use Case 4: Sign Typed Data (EIP-712)

```ts
const res = await HardwareSDK.evmSignTypedData(
  connectId,
  deviceId,
  {
    path: "m/44'/60'/0'/0/0",
    data: typedData,
    chainId: 1,
  },
);
```

**Parameters / å‚æ•°**

- `path`ï¼šå¿…å¡«ã€‚
- `data`ï¼šå¿…å¡«ï¼ŒEIPâ€‘712 JSON v4ï¼ŒåŒ…å« `domain/types/primaryType/message`ã€‚
- `chainId`ï¼šå¿…å¡«ã€‚

TypedData ç»“æ„å‚è€ƒï¼š

```ts
interface TypedData {
  domain: {
    name?: string;
    version?: string;
    chainId?: number;
    verifyingContract?: string;
    salt?: string;
  };
  types: Record<string, Array<{ name: string; type: string }>>;
  primaryType: string;
  message: Record<string, unknown>;
}
```

**Returns / è¿”å›**

`Promise<{ success, payload: { signature } }>`ï¼Œå¯ç”¨ `ethers.verifyTypedData` æ ¡éªŒã€‚

---

### Use Case 5: Sign Delegation Authorization (EIP-7702)

é’ˆå¯¹ EIPâ€‘7702 æˆæƒæ¶ˆæ¯çš„ä¸“ç”¨ç­¾åã€‚

```ts
const res = await HardwareSDK.evmSignDelegationAuthorization(
  connectId,
  deviceId,
  {
    path: "m/44'/60'/0'/0/0",
    chainId: 1,
    contractAddress: '0x...',
    nonce: 0,
  },
);
```

**Parameters / å‚æ•°**

- `path`ï¼šå¿…å¡«ã€‚
- `chainId`ï¼šå¿…å¡«ã€‚
- `contractAddress`ï¼šå¿…å¡«ï¼Œè¢«æˆæƒåˆçº¦åœ°å€ã€‚
- `nonce`ï¼šå¿…å¡«ï¼Œæˆæƒ nonceã€‚

**Returns / è¿”å›**

`Promise<{ success, payload: { signature } }>`ï¼Œä¸æˆæƒæ¶ˆæ¯å¯¹åº”ã€‚

## ğŸ”¹ äº¤äº’ä¸çŠ¶æ€

- æ¥å£ä»¥ Promise ç»“æŸï¼›ç”¨æˆ·æç¤ºé€šè¿‡ `UI_REQUEST` äº‹ä»¶è§¦å‘ï¼ˆè§£é”è®¾å¤‡ã€æ‰“å¼€ EVM Appã€ç¡®è®¤åœ°å€/äº¤æ˜“/æ¶ˆæ¯/Typed Data/æˆæƒï¼‰ã€‚
- åŒä¸€è®¾å¤‡è¯·ä¸²è¡Œè°ƒç”¨ï¼›å¤šæ¬¡ç­¾åå¯ä½¿ç”¨ `keepSession` å‡å°‘ PIN/å¯†ç çŸ­è¯­æç¤ºã€‚
- åœ¨ UI ä¸­ç›‘å¬ `UI_REQUEST` å¹¶å¼•å¯¼ç”¨æˆ·æ“ä½œï¼Œå…è®¸æ‰‹åŠ¨å–æ¶ˆ/é‡è¯•ã€‚

## ğŸ”¹ Examples / ç¤ºä¾‹

### Example: EIP-1559 Transaction / 1559 äº¤æ˜“ç­¾å

```ts
import HardwareSDK, { UI_REQUEST, UI_RESPONSE } from '@onekeyfe/hd-core';
import { serialize, TransactionTypes } from '@ethersproject/transactions';

const [{ connectId }] = await HardwareSDK.searchDevices();
const deviceId = (await HardwareSDK.getFeatures(connectId)).payload?.device_id;

HardwareSDK.on(UI_REQUEST.REQUEST_PIN, () => {
  // æç¤ºç”¨æˆ·åœ¨è®¾å¤‡è¾“å…¥ PINï¼Œæˆ–åœ¨è‡ªå®šä¹‰ UI æ”¶é›†åè°ƒç”¨ uiResponse
});

const accountPath = "m/44'/60'/0'/0/0";
await HardwareSDK.evmGetAddress(connectId, deviceId, { path: accountPath, showOnOneKey: true });

const tx = {
  to: '0xd0d6d6c5fe4a677d343cc433536bb717bae167dd',
  value: '0x0',
  data: '0x',
  nonce: '0x0',
  gasLimit: '0x5208',
  maxFeePerGas: '0x3b9aca00',
  maxPriorityFeePerGas: '0x59682f00',
  chainId: 1,
};

const { success, payload: sig } = await HardwareSDK.evmSignTransaction(connectId, deviceId, {
  path: accountPath,
  transaction: tx,
  chainId: 1,
  keepSession: true,
});

const rawTx = serialize({ ...tx, type: TransactionTypes.eip1559 }, {
  r: sig.r,
  s: sig.s,
  v: Number(sig.v),
});

// é€šè¿‡ RPC å¹¿æ’­ï¼Œä¾‹å¦‚ ethers.js provider.sendTransaction(rawTx)
```

### Example: Legacy Transaction / Legacy äº¤æ˜“

```ts
const legacyTx = {
  to: '0xRecipient',
  value: '0x2386f26fc10000', // 0.01 ETH
  data: '0x',
  nonce: '0x1',
  gasLimit: '0x5208',
  gasPrice: '0x3b9aca00', // 1 gwei
  chainId: 1,
};

const sig = await HardwareSDK.evmSignTransaction(connectId, deviceId, {
  path: accountPath,
  transaction: legacyTx,
  chainId: 1,
});
```

### Example: personal_sign / æ¶ˆæ¯ç­¾å

```ts
const message = 'Hello OneKey';
const messageHex = Buffer.from(message).toString('hex');

const res = await HardwareSDK.evmSignMessage(connectId, deviceId, {
  path: accountPath,
  messageHex,
  chainId: 1,
});
// res.payload.signature -> ç”¨ ethers.verifyMessage æ ¡éªŒ
```

### Example: Typed Data / EIP-712

```ts
const typedData = {
  types: {
    EIP712Domain: [
      { name: 'name', type: 'string' },
      { name: 'version', type: 'string' },
      { name: 'chainId', type: 'uint256' },
      { name: 'verifyingContract', type: 'address' },
    ],
    Mail: [
      { name: 'from', type: 'Person' },
      { name: 'to', type: 'Person' },
      { name: 'contents', type: 'string' },
    ],
    Person: [
      { name: 'name', type: 'string' },
      { name: 'wallet', type: 'address' },
    ],
  },
  primaryType: 'Mail',
  domain: {
    name: 'Ether Mail',
    version: '1',
    chainId: 1,
    verifyingContract: '0xCcCCccccCCCCcCCCCCCcCcCccCcCCCcCcccccccC',
  },
  message: {
    from: { name: 'Cow', wallet: '0xCD2a3d9F938E13CD947Ec05AbC7FE734Df8DD826' },
    to: { name: 'Bob', wallet: '0xbBbBBBBbbBBBbbbBbbBbbbbBBbBbbbbBbBbbBBbB' },
    contents: 'Hello, Bob!',
  },
};

const res = await HardwareSDK.evmSignTypedData(connectId, deviceId, {
  path: accountPath,
  data: typedData,
  chainId: 1,
});
// res.payload.signature -> ç”¨ ethers.verifyTypedData(...) æ¢å¤ç­¾åè€…
```

## ğŸ”¹ Validation & Troubleshooting / éªŒç­¾ä¸æ’éšœ

- éªŒç­¾ï¼š
  - äº¤æ˜“ï¼šç”¨ `ethers/viem` é‡æ–°åºåˆ—åŒ–ï¼Œæ ¡éªŒç­¾åå“ˆå¸Œä¸è®¾å¤‡æ˜¾ç¤ºä¸€è‡´ã€‚
  - personal_signï¼š`ethers.verifyMessage(message, sig.signature)`ã€‚
  - EIPâ€‘712ï¼š`ethers.verifyTypedData(domain, types, message, sig.signature)`ã€‚
  - EIPâ€‘7702ï¼šæŒ‰æˆæƒæ¶ˆæ¯æ ¼å¼éªŒè¯æ¢å¤åœ°å€ã€‚
- å¸¸è§é™åˆ¶ï¼šè¶…å¤§ `data` æˆ–å¼‚å¸¸å­—æ®µå¯èƒ½è¢«æ‹’ï¼›`chainId` å¿…é¡»ä¸å¹¿æ’­ç½‘ç»œä¸€è‡´ã€‚
- å¸¸è§é”™è¯¯ï¼š
  - è·¯å¾„ä¸ä¸€è‡´ï¼šé»˜è®¤ `m/44'/60'/0'/0/0`ï¼ŒæŒ‰è´¦æˆ·/åœ°å€é€’å¢ï¼›åŠ¡å¿…ä¸åœ°å€ç¡®è®¤ä¸€è‡´ã€‚
  - Gas å­—æ®µç¼ºå¤±ï¼š1559 å¿…å¡« `maxFeePerGas + maxPriorityFeePerGas`ï¼›Legacy ä»…å¡« `gasPrice`ã€‚
  - è®¾å¤‡äº¤äº’é˜»å¡ï¼šä¸²è¡Œè°ƒç”¨åŒä¸€è®¾å¤‡ï¼›ä½¿ç”¨ `keepSession` å¤ç”¨ä¼šè¯ï¼Œé¿å…é‡å¤ PIN/å¯†ç çŸ­è¯­å¼¹çª—ã€‚
  - ç”¨æˆ·æ‹’ç­¾/è¶…æ—¶ï¼šæä¾›é‡è¯•/å–æ¶ˆï¼Œä¸è¦è‡ªåŠ¨é‡æ’­ã€‚

ç›¸å…³é“¾æ–¹æ³•æ–‡æ¡£ï¼š[evmSignTransaction](/zh/hardware-sdk/chains/ethereum-and-evm/evmsigntransaction) Â· [evmSignMessage](/zh/hardware-sdk/chains/ethereum-and-evm/evmsignmessage) Â· [evmSignTypedData](/zh/hardware-sdk/chains/ethereum-and-evm/evmsigntypeddata)ã€‚
