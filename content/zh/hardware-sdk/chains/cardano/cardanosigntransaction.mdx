---
title: cardanoSignTransaction
---

# cardanoSignTransaction

## 使用要求

* 固件版本要求
  * Touch: 4.1.0
  * Classic/Mini: 3.0.0

### Cardano：签名交易 <a href="#cardano-sign-transaction" id="cardano-sign-transaction"></a>

请求设备对给定交易进行签名。用户需要在 OneKey 上确认所有交易详情。

```javascript
const response = await HardwareSDK.cardanoSignTransaction(connectId, deviceId, params);
```

### 参数 <a href="#params" id="params"></a>

[可选通用参数](../../../core-api-guide#common-params)

CardanoSignTransaction 类型

* `signingMode` - _必需_ CardanoTxSigningMode
* `inputs` - _必需_ CardanoInput 的 `Array`
* `outputs` - _必需_ CardanoOutput 的 `Array`
* `fee` - _必需_ `String`
* `protocolMagic` - _必需_ `Integer` 主网为 764824073，Preprod 测试网为 1，Preview 测试网为 2
* `networkId` - _必需_ `Integer` 主网为 1，测试网为 0
* `ttl` - _可选_ `String`
* `validityIntervalStart` - _可选_ `String`
* `certificates` - _可选_ CardanoCertificate 的 `Array`
* `withdrawals` - _可选_ CardanoWithdrawal 的 `Array`
* `auxiliaryData` - _可选_ CardanoAuxiliaryData
* `mint` - _可选_ CardanoMint
* `scriptDataHash` - _可选_ `String`
* `collateralInputs` - _可选_ CardanoCollateralInput 的 `Array`
* `requiredSigners` - _可选_ CardanoRequiredSigner 的 `Array`
* `collateralReturn` - _可选_ CardanoOutput
* `totalCollateral` - _可选_ `String`
* `referenceInputs` - _可选_ CardanoReferenceInput 的 `Array`
* `additionalWitnessRequests` - _可选_ `string | Array<number>`（路径）的 `Array`。用于多签和代币铸造见证请求，因为这些无法从交易参数中确定。
* `metadata` - _已移除_ - 请使用 `auxiliaryData` 代替
* `derivationType` - _可选_ `CardanoDerivationType` 枚举。决定使用的派生类型。默认设置为 ICARUS=1。
* `includeNetworkId` - _可选_ `Boolean`。决定是否将 `networkId` 显式序列化到交易体中。默认为 `false`。

#### CardanoTxSigningMode <a href="#cardanotxsigningmode" id="cardanotxsigningmode"></a>

**`ORDINARY_TRANSACTION`**

表示转移资金、委托质押或提取奖励的普通用户交易。交易将由从 `inputs`、`certificates` 和 `withdrawals` 中包含的路径派生的密钥进行见证。此外，如果存在代币铸造，交易还将由从 `additionalWitnessRequests` 中包含的路径派生的密钥进行见证。

该交易

* _应该_ 在所有 `inputs` 上具有有效的 `path` 属性
* _不能_ 包含矿池注册证书
* _不能_ 包含 `collateralInputs`、`collateralReturn`、`totalCollateral` 和 `referenceInputs`
* _必须_ 在证书和提款中包含路径作为质押凭证（不能使用密钥哈希或脚本哈希）
* _可以_ 仅包含 1852 和 1855 路径
* _不能_ 在交易不铸造/销毁代币时包含 1855 见证请求

#### 质押池注册证书说明 <a href="#stake-pool-registration-certificate-specifics" id="stake-pool-registration-certificate-specifics"></a>

OneKey 支持以矿池所有者身份签署质押池注册证书。交易可能包含外部输入（例如属于矿池运营者），OneKey 无法验证它们是否确实是外部的，因此如果我们允许使用支出密钥签署交易，则存在从用户不打算支出的输入中损失资金的风险。此外，如果交易中有任何提款，也存在意外签署提款的风险。为了降低这些风险，我们为质押池注册交易引入了特殊的验证规则，这些规则也在 OneKey 上进行验证。验证规则如下：

1. 交易不能包含任何其他证书，甚至不能包含另一个质押池注册
2. 交易不能包含任何提款
3. 交易输入必须全部是外部的，即 path 必须是 undefined 或 null
4. 必须恰好有一个所有者作为质押路径传递，其余所有者应作为 bech32 编码的奖励地址传递

#### 治理注册（Catalyst 和其他） <a href="#governance-registration-catalyst-and-other" id="governance-registration-catalyst-and-other"></a>

OneKey 支持签署包含治理注册的辅助数据的交易。治理注册曾经遵循 [CIP-15](https://cips.cardano.org/cips/cip15/)，现已被 [CIP-36](https://cips.cardano.org/cips/cip36/) 取代。目前，OneKey 支持 CIP-15 和 CIP-36 格式，可以在 `format` 字段中指定预期标准（默认为 CIP-15）。它们的区别如下：

* CIP-36 允许将投票权委托给多个具有不同投票权的投票公钥（CardanoGovernanceRegistrationDelegation），作为仅提供单个投票公钥的替代方案。请注意，OneKey 固件在单个治理注册中最多支持 32 个委托。
* CIP-36 注册包含 votingPurpose 字段。值 0 用于 Catalyst 投票，值 1 用于其他目的。如果未提供值，OneKey 默认序列化 0（如果使用 CIP-36 格式）。

OneKey 目前不支持 1694 派生路径。

### 示例 <a href="#transaction-examples" id="transaction-examples"></a>

**普通交易**

```javascript
HardwareSDK.cardanoSignTransaction(connectId, deviceId, {
    signingMode: CardanoTxSigningMode.ORDINARY_TRANSACTION,
    inputs: [
        {
            path: "m/1852'/1815'/0'/0/1",
            prev_hash: '1af8fa0b754ff99253d983894e63a2b09cbb56c833ba18c3384210163f63dcfc',
            prev_index: 0,
        },
    ],
    outputs: [
        {
            address: 'Ae2tdPwUPEZCanmBz5g2GEwFqKTKpNJcGYPKfDxoNeKZ8bRHr8366kseiK2',
            amount: '3003112',
        },
        {
            addressParameters: {
                addressType: CardanoAddressType.BASE,
                path: "m/1852'/1815'/0'/0/0",
                stakingPath: "m/1852'/1815'/0'/2/0",
            },
            amount: '7120787',
        },
        {
            format: CardanoTxOutputSerializationFormat.ARRAY_LEGACY,
            address:
                'addr1q84sh2j72ux0l03fxndjnhctdg7hcppsaejafsa84vh7lwgmcs5wgus8qt4atk45lvt4xfxpjtwfhdmvchdf2m3u3hlsd5tq5r',
            amount: '2000000',
            tokenBundle: [
                {
                    policyId: '95a292ffee938be03e9bae5657982a74e9014eb4960108c9e23a5b39',
                    tokenAmounts: [
                        {
                            assetNameBytes: '74652474436f696e',
                            amount: '7878754',
                        },
                    ],
                },
            ],
        },
        {
            address: 'addr1w9rhu54nz94k9l5v6d9rzfs47h7dv7xffcwkekuxcx3evnqpvuxu0',
            amount: '1',
            datumHash: '3b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b7',
        },
        {
            format: CardanoTxOutputSerializationFormat.MAP_BABBAGE,
            address: 'addr1w9rhu54nz94k9l5v6d9rzfs47h7dv7xffcwkekuxcx3evnqpvuxu0',
            amount: '1',
            inlineDatum:
                '3b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b73b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b73b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b73b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b73b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b73b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b73b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b73b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b7',
            referenceScript:
                '3b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b73b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b73b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b73b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b73b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b73b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b73b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b73b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b7',
        },
    ],
    fee: '42',
    ttl: '10',
    validityIntervalStart: '20',
    certificates: [
        {
            type: CardanoCertificateType.STAKE_REGISTRATION,
            path: "m/1852'/1815'/0'/2/0",
        },
        {
            type: CardanoCertificateType.STAKE_DEREGISTRATION,
            path: "m/1852'/1815'/0'/2/0",
        },
        {
            type: CardanoCertificateType.STAKE_DELEGATION,
            path: "m/1852'/1815'/0'/2/0",
            pool: 'f61c42cbf7c8c53af3f520508212ad3e72f674f957fe23ff0acb4973',
        },
    ],
    withdrawals: [
        {
            path: "m/1852'/1815'/0'/2/0",
            amount: '1000',
        },
    ],
    auxiliaryData: {
        hash: 'ea4c91860dd5ec5449f8f985d227946ff39086b17f10b5afb93d12ee87050b6a',
    },
    scriptDataHash: 'd593fd793c377ac50a3169bb8378ffc257c944da31aa8f355dfa5a4f6ff89e02',
    protocolMagic: 764824073,
    networkId: 1,
    includeNetworkId: false,
});
```

**质押池注册**

```javascript
HardwareSDK.cardanoSignTransaction(connectId, deviceId, {
    signingMode: CardanoTxSigningMode.POOL_REGISTRATION_AS_OWNER,
    inputs: [
        {
            // 注意此处不提供 path
            prev_hash: '3b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b7',
            prev_index: 0,
        },
    ],
    outputs: {
        address:
            'addr1q84sh2j72ux0l03fxndjnhctdg7hcppsaejafsa84vh7lwgmcs5wgus8qt4atk45lvt4xfxpjtwfhdmvchdf2m3u3hlsd5tq5r',
        amount: '1000000',
    },
    fee: '300000',
    ttl: '500000000',
    protocolMagic: 764824073,
    networkId: 1,
    includeNetworkId: false,
    certificates: [
        {
            type: CardanoCertificateType.STAKE_POOL_REGISTRATION,
            poolParameters: {
                poolId: 'f61c42cbf7c8c53af3f520508212ad3e72f674f957fe23ff0acb4973',
                vrfKeyHash: '198890ad6c92e80fbdab554dda02da9fb49d001bbd96181f3e07f7a6ab0d0640',
                pledge: '500000000', // lovelace 金额
                cost: '340000000', // lovelace 金额
                margin: {
                    // numerator/denominator 应该 <= 1，然后转换为百分比
                    numerator: '1',
                    denominator: '2',
                },
                rewardAccount: 'stake1uya87zwnmax0v6nnn8ptqkl6ydx4522kpsc3l3wmf3yswygwx45el', // bech32 编码的质押池奖励账户
                owners: [
                    {
                        stakingKeyPath: "m/1852'/1815'/0'/2/0", // 这是将在 OneKey 上签署交易的所有者密钥的路径
                    },
                    {
                        stakingKeyHash: '3a7f09d3df4cf66a7399c2b05bfa234d5a29560c311fc5db4c490711', // 其他所有者
                    },
                ],
                relays: [
                    {
                        type: CardanoPoolRelayType.SINGLE_HOST_IP,
                        ipv4Address: '192.168.0.1',
                        ipv6Address: '2001:0db8:85a3:0000:0000:8a2e:0370:7334', // 完整形式的 ipv6 地址
                        port: 1234,
                    },
                    {
                        type: CardanoPoolRelayType.SINGLE_HOST_IP,
                        ipv6Address: '2001:0db8:85a3:0000:0000:8a2e:0370:7334',
                        port: 1234,
                    },
                    {
                        type: CardanoPoolRelayType.SINGLE_HOST_IP,
                        ipv4Address: '192.168.0.1',
                        port: 1234,
                    },
                    {
                        type: CardanoPoolRelayType.SINGLE_HOST_NAME,
                        hostName: 'www.test.test',
                        port: 1234,
                    },
                    {
                        type: CardanoPoolRelayType.MULTIPLE_HOST_NAME,
                        hostName: 'www.test2.test', // 最长 64 个字符
                    },
                ],
                metadata: {
                    url: 'https://www.test.test', // 最长 64 个字符
                    hash: '914c57c1f12bbf4a82b12d977d4f274674856a11ed4b9b95bd70f5d41c5064a6',
                },
            },
        },
    ],
});
```

**治理投票密钥注册**

```javascript
HardwareSDK.cardanoSignTransaction(connectId, deviceId, {
    signingMode: CardanoTxSigningMode.ORDINARY_TRANSACTION,
    inputs: [
        {
            path: "m/1852'/1815'/0'/0/0",
            prev_hash: '3b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b7',
            prev_index: 0,
        },
    ],
    outputs: [
        {
            address:
                'addr1q84sh2j72ux0l03fxndjnhctdg7hcppsaejafsa84vh7lwgmcs5wgus8qt4atk45lvt4xfxpjtwfhdmvchdf2m3u3hlsd5tq5r',
            amount: '3003112',
        },
    ],
    fee: '42',
    ttl: '10',
    auxiliaryData: {
        governanceRegistrationParameters: {
            votingPublicKey: '1af8fa0b754ff99253d983894e63a2b09cbb56c833ba18c3384210163f63dcfc',
            stakingPath: "m/1852'/1815'/0'/2/0",
            rewardAddressParameters: {
                addressType: CardanoAddressType.REWARD,
                stakingPath: "m/1852'/1815'/0'/2/0",
            },
            nonce: '22634813',
        },
    },
    protocolMagic: 764824073,
    networkId: 1,
    includeNetworkId: false,
});
```

#### 返回结果 <a href="#result" id="result"></a>

由于内存限制，OneKey 的 Cardano 实现引入了交易流式传输，OneKey 不再将整个序列化交易作为 `CardanoSignTransaction` 调用的结果返回。相反，返回交易哈希、交易见证和辅助数据补充，序列化交易需要由客户端组装。

CardanoSignedTxData 类型

```javascript
{
    success: true,
    payload: {
        hash: string,
        witnesses: CardanoSignedTxWitness[],
        auxiliaryDataSupplement?: CardanoAuxiliaryDataSupplement,
    }
}
```

#### 示例：

```javascript
{
    success: true,
    payload: {
        hash: "73e09bdebf98a9e0f17f86a2d11e0f14f4f8dae77cdf26ff1678e821f20c8db6",
        witnesses: [
            {
                type: CardanoTxWitnessType.BYRON_WITNESS,
                pubKey: '89053545a6c254b0d9b1464e48d2b5fcf91d4e25c128afb1fcfc61d0843338ea',
                signature:
                    'da07ac5246e3f20ebd1276476a4ae34a019dd4b264ffc22eea3c28cb0f1a6bb1c7764adeecf56bcb0bc6196fd1dbe080f3a7ef5b49f56980fe5b2881a4fdfa00',
                chainCode:
                    '26308151516f3b0e02bb1638142747863c520273ce9bd3e5cd91e1d46fe2a635',
            },
            {
                type: CardanoTxWitnessType.SHELLEY_WITNESS,
                pubKey: '5d010cf16fdeff40955633d6c565f3844a288a24967cf6b76acbeb271b4f13c1',
                signature:
                    '622f22d03bc9651ddc5eb2f5dc709ac4240a64d2b78c70355dd62106543c407d56e8134c4df7884ba67c8a1b5c706fc021df5c4d0ff37385c30572e73c727d00',
                chainCode: null,
            },
        ],
        auxiliaryDataSupplement: {
            type: 1,
            auxiliaryDataHash:
                'a943e9166f1bb6d767b175384d3bd7d23645170df36fc1861fbf344135d8e120',
            governanceSignature:
                '74f27d877bbb4a5fc4f7c56869905c11f70bad0af3de24b23afaa1d024e750930f434ecc4b73e5d1723c2cb8548e8bf6098ac876487b3a6ed0891cb76994d409',
        },
    }
}
```

错误

```javascript
{
    success: false,
    payload: {
        error: string, // 错误信息
        code: number // 错误码
    }
}
```


