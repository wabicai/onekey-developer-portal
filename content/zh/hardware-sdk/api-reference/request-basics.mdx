---
title: 请求基础
---

# 请求基础

整理 OneKey 硬件交互的通用要素：设备标识、通用参数、路径选择以及事件流。大部分链方法都遵循相同的调用范式。

## 最小调用流程

```
初始化 → 搜索设备 → 选择设备 (connectId) → 获取特征得到 deviceId
       → 监听 UI/DEVICE/FIRMWARE 事件 → 调用链方法
       → 设备确认 (PIN/密码短语/按键) → 返回签名或数据
```

```ts
import HardwareSDK, {
  DEVICE_EVENT,
  DEVICE,
  UI_EVENT,
  UI_REQUEST,
  UI_RESPONSE,
} from '@onekeyfe/hd-core';

await HardwareSDK.init({ env: 'webusb', debug: false });

const [{ connectId }] = await HardwareSDK.searchDevices();
const { payload: features } = await HardwareSDK.getFeatures(connectId);
const deviceId = features?.device_id;

HardwareSDK.on(DEVICE_EVENT, message => {
  if (message.type === DEVICE.CONNECT) {
    console.info('设备已连接');
  }
});

HardwareSDK.on(UI_REQUEST.REQUEST_PIN, payload => {
  // 在自定义 UI 中采集 PIN，或提示用户在设备输入
});

HardwareSDK.uiResponse({
  type: UI_RESPONSE.RECEIVE_PIN,
  payload: '1234', // 或 passphraseOnDevice = true 在设备输入
});

const path = "m/44'/60'/0'/0/0";
const { success, payload } = await HardwareSDK.evmSignTransaction(connectId, deviceId, {
  path,
  transaction: { to: '0x...', value: '0x0', gasLimit: '0x5208', chainId: 1 },
  keepSession: true,
});
```

## 设备标识符

- `connectId`：来自 `searchDevices()` 结果（字段 `connectId`），在连接会话间保持稳定。
- `deviceId`：来自 `getFeatures(connectId)` 的 `device_id`，设备擦除或出厂重置后会变化。

## 通用参数（CommonParams）

在链方法的第三个参数对象中直接传入：

- `keepSession?: boolean` 方法完成后保持会话，复用缓存状态（降低多次确认成本）。
- `retryCount?: number` / `pollIntervalTime?: number` / `timeout?: number` 轮询重试配置。
- `passphraseState?: string` / `useEmptyPassphrase?: boolean` 控制密码短语钱包与标准钱包。
- `initSession?: boolean` 在调用开始时初始化会话并缓存 `passphraseState`。
- `deriveCardano?: boolean` 为会话预先派生 Cardano 种子（非 Cardano 场景默认 false）。
- `detectBootloaderDevice?: boolean` 检测引导加载模式并提前失败。
- `skipWebDevicePrompt?: boolean` 跳过浏览器设备选择器（高级流程使用）。

提示：

- 密码短语钱包：组合 `passphraseState` + `keepSession`，减少重复输入；标准钱包可配合 `useEmptyPassphrase`。
- WebUSB：必须 HTTPS，并在搜索前让用户授权设备。

## 路径与账户选择（HD Path）

- `path: string | number[]` 使用 BIP44 路径；ed25519 链必须全硬化。
- 常用示例：
  - EVM：`m/44'/60'/0'/0/0`
  - BTC：`m/49'/0'/0'`（账户）或 `m/49'/0'/0'/0/0`（首个地址）
  - Solana：`m/44'/501'/0'/0'`
- 数字数组写法示例：`[(44 | 0x80000000) >>> 0, (0 | 0x80000000) >>> 0, 0x80000000, 0, 0]`

## 事件与 UI 交互

- 事件分类：`UI_EVENT`（UI 请求）、`DEVICE_EVENT`（设备生命周期）、`FIRMWARE_EVENT`（固件进度）。
- 高级监听：`HardwareSDK.on(UI_EVENT, (message) => {})` 获取 `{ event, type, payload }`。
- 直连监听：`HardwareSDK.on(UI_REQUEST.REQUEST_PIN, payload => {})` 仅接收 payload。
- 响应 UI：使用 `HardwareSDK.uiResponse`，常见类型：
  - `UI_RESPONSE.RECEIVE_PIN` 提供 PIN
  - `UI_RESPONSE.RECEIVE_PASSPHRASE` 提供密码短语（`passphraseOnDevice` 可强制在设备输入）
  - `UI_RESPONSE.SELECT_DEVICE_IN_BOOTLOADER_FOR_WEB_DEVICE` 选择 WebUSB 引导加载设备

## 错误与重试

- 通用错误码见 [错误码](./error-code)。
- 可结合 `retryCount`、`pollIntervalTime` 配置重试，或监听 `DEVICE.CHANGED` 处理设备切换。

## 快速回顾

1. 初始化 → 搜索设备 → 获取 `connectId`、`deviceId`
2. 监听 `UI/DEVICE/FIRMWARE` 事件并准备 `uiResponse`
3. 选定 HD Path 与链参数，调用对应链方法并传入通用参数
4. 处理用户确认并获取签名/结果
