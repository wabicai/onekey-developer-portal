import {
  Callout,
  Card,
  CardGrid,
  Steps,
  Step,
  ArchitectureLayer,
  ArchitectureDiagram,
  DecisionCard,
  FeatureTable,
  QuickActions,
  SectionHeader,
  Roadmap,
} from './components/DocComponents'
import {
  Globe,
  Puzzle,
  BookOpen,
  Layers,
  Link2,
  Zap,
  Code2,
  GitBranch,
  Smartphone,
  Monitor,
  Cpu,
} from 'lucide-react'
import { ChainIcon } from './components/ChainIcons'

# OneKey dApp 开发者文档规划

<Callout type="tip" title="文档目标">
  本文档用于规划 OneKey dApp 集成文档的结构设计。基于 MetaMask 文档分析，结合 OneKey 的差异化优势（多链原生支持、硬件钱包集成），设计清晰的开发者接入路径。
</Callout>

---

<SectionHeader
  title="快速决策"
  description="根据你的使用场景，选择最适合的接入方式"
  badge="Start Here"
/>

<DecisionCard
  question="你需要哪种接入方式？"
  options={[
    {
      label: "Wallet API (原生 Provider)",
      description: "直接使用 EIP-6963/1193，无需额外依赖，精细控制",
      href: "#wallet-api"
    },
    {
      label: "框架集成 (推荐)",
      description: "使用 Wagmi/RainbowKit，快速集成，开箱即用 UI",
      href: "#frameworks"
    },
    {
      label: "多链 dApp",
      description: "需要同时支持 EVM + Bitcoin + Solana 等多条链",
      href: "#multi-chain"
    },
    {
      label: "移动端连接",
      description: "需要二维码扫码或 WalletConnect 移动端体验",
      href: "#walletconnect"
    }
  ]}
/>

---

<SectionHeader
  title="OneKey Provider 架构"
  description="理解 cross-inpage-provider 的分层设计"
/>

<ArchitectureDiagram title="OneKey Provider 完整架构">
  <ArchitectureLayer
    title="dApp 接入层 (开发者使用)"
    color="green"
    items={['Wallet API (EIP-6963)', 'Wagmi / RainbowKit', 'Web3Modal', 'WalletConnect']}
  />
  <ArchitectureLayer
    title="Provider 接口层 (各链 RPC)"
    color="blue"
    items={['ETH Provider', 'BTC Provider', 'Solana Provider', 'Cosmos Provider', 'Aptos Provider', '...']}
  />
  <ArchitectureLayer
    title="cross-inpage-provider (注入层)"
    color="purple"
    items={['packages/injected', 'packages/extension', 'packages/desktop', 'packages/native', 'packages/webview']}
  />
  <ArchitectureLayer
    title="OneKey 钱包 (签名与密钥)"
    color="amber"
    items={['软件钱包 (扩展/桌面/App)', '硬件钱包 (Pro/Touch/Classic)', 'BIP32/39/44 密钥派生']}
  />
</ArchitectureDiagram>

---

<SectionHeader
  title="与 MetaMask 的差异"
  description="明确 OneKey 的优势与限制，设计合适的文档结构"
/>

<FeatureTable
  headers={['功能', 'MetaMask', 'OneKey', '文档策略']}
  rows={[
    ['官方跨平台 SDK', true, false, '推荐 WalletConnect + 第三方库'],
    ['移动端深链接', true, false, '使用 WalletConnect 协议'],
    ['EIP-7702 智能账户', true, false, '暂不提及，后续支持再添加'],
    ['Snaps 扩展生态', true, false, '不提及'],
    ['多链原生 Provider', false, true, '重点突出，专门章节'],
    ['硬件钱包原生集成', false, true, '硬件章节深入'],
    ['EIP-6963 支持', true, true, '作为首选推荐方式'],
    ['完全开源', false, true, '概览页面提及'],
  ]}
/>

<Callout type="info" title="关键差异">
  OneKey 没有像 `@metamask/sdk` 那样的官方跨平台 SDK。对于移动端连接场景，推荐使用 WalletConnect 或第三方框架（如 RainbowKit）来实现。
</Callout>

---

<SectionHeader
  title="推荐文档目录结构"
  description="基于分析结果的最终文档架构设计"
  badge="Final Design"
/>

```
/connect-to-software (dApp 接入)
│
├── index.mdx                      # 概览与快速入门
│   ├── 选择接入方式决策树
│   ├── 5 分钟快速连接示例
│   └── 平台能力对比表
│
├── /wallet-api                    # 一、原生 Provider (Wallet API)
│   ├── index.mdx                  # 概览
│   ├── connect.mdx                # 连接钱包 (EIP-6963 / EIP-1193)
│   ├── provider.mdx               # Provider 接口
│   ├── signing.mdx                # 签名 (personal_sign / EIP-712 / SIWE)
│   ├── transactions.mdx           # 交易发送与确认
│   ├── networks.mdx               # 网络管理
│   └── events.mdx                 # 事件监听
│
├── /multi-chain                   # 二、多链支持 (OneKey 核心差异化)
│   ├── index.mdx                  # 多链概览与架构图
│   ├── ethereum.mdx               # EVM 链
│   ├── bitcoin.mdx                # Bitcoin
│   ├── solana.mdx                 # Solana
│   ├── cosmos.mdx                 # Cosmos
│   ├── aptos.mdx                  # Aptos
│   ├── sui.mdx                    # Sui
│   └── others.mdx                 # 其他链
│
├── /frameworks                    # 三、框架集成
│   ├── index.mdx                  # 框架选型指南
│   ├── wagmi.mdx                  # Wagmi + viem
│   ├── rainbowkit.mdx             # RainbowKit
│   ├── web3modal.mdx              # Web3Modal (AppKit)
│   ├── web3-onboard.mdx           # Web3-Onboard
│   └── walletconnect.mdx          # WalletConnect (移动端连接)
│
├── /guides                        # 四、开发指南
│   ├── best-practices.mdx         # 最佳实践
│   ├── migration.mdx              # 迁移指南
│   ├── troubleshooting.mdx        # 常见问题
│   └── security.mdx               # 安全建议
│
└── /reference                     # 五、API 参考
    ├── rpc-methods.mdx            # JSON-RPC 方法完整列表
    ├── error-codes.mdx            # 错误码
    └── typescript.mdx             # TypeScript 类型定义
```

---

<SectionHeader
  title="核心页面内容规划"
  description="每个页面的关键内容和组件设计"
/>

<CardGrid cols={2}>
  <Card
    icon={Globe}
    title="概览页 (index.mdx)"
    description="决策树组件帮助用户选择接入方式，5 行代码快速开始示例，平台能力对比表"
    tags={['DecisionCard', 'CodeBlock', 'FeatureTable']}
  />
  <Card
    icon={Link2}
    title="连接钱包 (connect.mdx)"
    description="EIP-6963 完整 TypeScript 示例，Vanilla 和 React 两个版本，OneKey 标识 (rdns)"
    tags={['Steps', 'CodeBlock', 'Callout']}
  />
  <Card
    icon={Layers}
    title="多链概览 (multi-chain/index.mdx)"
    description="$onekey 命名空间架构图，各链 Provider 入口表格，接口兼容性说明"
    tags={['ArchitectureDiagram', 'FeatureTable']}
  />
  <Card
    icon={Puzzle}
    title="框架集成 (frameworks/index.mdx)"
    description="框架选型对比表，各框架快速开始步骤，EIP-6963 自动发现说明"
    tags={['FeatureTable', 'Steps', 'CardGrid']}
  />
</CardGrid>

---

<SectionHeader
  title="cross-inpage-provider 包映射"
  description="文档章节与代码包的对应关系"
/>

<FeatureTable
  headers={['文档章节', '对应代码包', '说明']}
  rows={[
    ['Wallet API / 连接', 'onekey-eth-provider', 'EIP-6963 实现'],
    ['Wallet API / Provider', 'packages/core + types', '核心通信逻辑'],
    ['Wallet API / 签名', 'onekey-eth-provider', '签名方法实现'],
    ['多链 / Bitcoin', 'onekey-btc-provider', 'Unisat 兼容接口'],
    ['多链 / Solana', 'onekey-solana-provider', 'Phantom 兼容接口'],
    ['多链 / Cosmos', 'onekey-cosmos-provider', 'Keplr 兼容接口'],
    ['多链 / Aptos', 'onekey-aptos-provider', 'Petra 兼容接口'],
    ['框架集成', 'EIP-6963 发现', '通过 injected connector'],
  ]}
/>

---

<SectionHeader
  title="实施路线图"
  description="文档构建的优先级和进度追踪"
/>

<Roadmap
  items={[
    { label: 'MetaMask 文档结构分析', status: 'done' },
    { label: 'cross-inpage-provider 架构分析', status: 'done' },
    { label: 'OneKey 差异化功能梳理', status: 'done' },
    { label: '文档目录结构设计', status: 'done' },
    { label: 'MDX 组件库开发', status: 'done' },
    { label: 'Wallet API 章节编写', status: 'in-progress' },
    { label: '多链支持章节编写', status: 'planned' },
    { label: '框架集成章节编写', status: 'planned' },
    { label: 'API 参考文档生成', status: 'planned' },
    { label: '现有文档迁移整合', status: 'planned' },
  ]}
/>

---

<SectionHeader
  title="下一步行动"
  description="立即可执行的任务清单"
/>

<Steps>
  <Step number={1} title="重构现有 /provider 目录">
    将 `/connect-to-software/provider` 拆分为 `/wallet-api` (连接/签名/交易) 和 `/multi-chain` (各链 API)。保持 URL 兼容性。
  </Step>
  <Step number={2} title="更新 _meta.js 导航">
    修改侧边栏导航结构，添加分隔符和新章节。参考新目录结构设计。
  </Step>
  <Step number={3} title="编写概览页决策树">
    使用 DecisionCard 组件，帮助开发者快速选择接入方式。添加 5 分钟快速开始示例代码。
  </Step>
  <Step number={4} title="补充 EIP-6963 完整示例">
    提供 Vanilla TypeScript 和 React TypeScript 两个版本的完整可运行代码。
  </Step>
  <Step number={5} title="添加多链架构图">
    使用 ArchitectureDiagram 组件展示 $onekey 命名空间下各链 Provider 的关系。
  </Step>
</Steps>

<QuickActions
  actions={[
    { label: '查看现有 Provider 文档', href: '/zh/connect-to-software/provider', primary: true },
    { label: '查看 cross-inpage-provider', href: 'https://github.com/onekeyhq/cross-inpage-provider', external: true },
    { label: '查看 MetaMask 文档', href: 'https://docs.metamask.io/wallet', external: true },
  ]}
/>

---

## MetaMask SDK 机制详解

<Callout type="warning" title="OneKey 不提供官方 SDK">
  以下内容用于理解 MetaMask SDK 的工作原理。OneKey 目前没有类似的官方 SDK 包，移动端连接推荐使用 WalletConnect 协议。
</Callout>

### 为什么需要 SDK？

<FeatureTable
  headers={['场景', 'Wallet API', 'SDK']}
  rows={[
    ['桌面浏览器有扩展', '直接连接', '直接连接'],
    ['桌面浏览器无扩展', '无法连接', 'QR 码连接'],
    ['移动浏览器', '需要内置浏览器', '深链接跳转'],
    ['React Native', '不支持', '原生集成'],
  ]}
/>

### SDK 连接架构

```
桌面浏览器 dApp              移动浏览器 dApp
      │                           │
      ▼                           ▼
检测到扩展？──Yes──► 直接连接    生成 Deeplink
      │                           │
      No                          ▼
      │                     跳转到钱包 App
      ▼                           │
显示 QR 码 ◄──────────────────────┘
      │
      ▼
用户扫码 ──► 钱包 Mobile 连接
```

### 连接流程详解

<Steps>
  <Step number={1} title="dApp 生成密钥对">
    使用 ECIES 椭圆曲线加密生成公私钥对，用于后续的端到端加密通信。
  </Step>
  <Step number={2} title="生成 Deeplink/QR 码">
    包含 dApp 的 ECIES 公钥、Socket.io 房间 ID、dApp 元数据（名称、图标、URL）。
  </Step>
  <Step number={3} title="用户扫码/点击深链接">
    钱包 App 打开，解析链接信息，连接到 Socket.io 服务器。
  </Step>
  <Step number={4} title="建立加密通道">
    双方通过 Socket.io 交换公钥，生成共享密钥，建立端到端加密通道。
  </Step>
  <Step number={5} title="发送 JSON-RPC 请求">
    所有后续通信通过加密通道进行，与 Wallet API 调用方式相同。
  </Step>
</Steps>

---

## 完整代码示例

### EIP-6963 发现钱包 (Vanilla TypeScript)

```typescript
// types.ts
interface EIP6963ProviderInfo {
  uuid: string
  name: string
  icon: string
  rdns: string
}

interface EIP6963ProviderDetail {
  info: EIP6963ProviderInfo
  provider: EIP1193Provider
}

interface EIP1193Provider {
  request(args: { method: string; params?: unknown[] }): Promise<unknown>
  on(event: string, handler: (...args: any[]) => void): void
  removeListener(event: string, handler: (...args: any[]) => void): void
}

// wallet-discovery.ts
class WalletDiscovery {
  private providers: EIP6963ProviderDetail[] = []

  constructor() {
    window.addEventListener('eip6963:announceProvider', (event: any) => {
      if (this.providers.some(p => p.info.uuid === event.detail.info.uuid)) {
        return
      }
      this.providers.push(event.detail)
    })
  }

  discover() {
    window.dispatchEvent(new Event('eip6963:requestProvider'))
  }

  getOneKey() {
    return this.providers.find(p => p.info.rdns === 'so.onekey.app.wallet')
  }

  getAll() {
    return this.providers
  }
}

// 使用
const discovery = new WalletDiscovery()
discovery.discover()

async function connectOneKey() {
  const onekey = discovery.getOneKey()
  if (!onekey) {
    throw new Error('OneKey not installed')
  }

  const accounts = await onekey.provider.request({
    method: 'eth_requestAccounts'
  }) as string[]

  return accounts[0]
}
```

### EIP-6963 React Hook

```tsx
import { useSyncExternalStore, useCallback, useState } from 'react'

// Store
const createStore = () => {
  let providers: EIP6963ProviderDetail[] = []
  let listeners: (() => void)[] = []

  window.addEventListener('eip6963:announceProvider', (event: any) => {
    if (providers.some(p => p.info.uuid === event.detail.info.uuid)) return
    providers = [...providers, event.detail]
    listeners.forEach(l => l())
  })

  window.dispatchEvent(new Event('eip6963:requestProvider'))

  return {
    subscribe: (callback: () => void) => {
      listeners.push(callback)
      return () => { listeners = listeners.filter(l => l !== callback) }
    },
    getSnapshot: () => providers
  }
}

const store = createStore()

// Hook
export function useWalletProviders() {
  return useSyncExternalStore(store.subscribe, store.getSnapshot)
}

// Component
export function WalletList() {
  const providers = useWalletProviders()
  const [account, setAccount] = useState<string>()
  const [selected, setSelected] = useState<EIP6963ProviderDetail>()

  const connect = useCallback(async (provider: EIP6963ProviderDetail) => {
    const accounts = await provider.provider.request({
      method: 'eth_requestAccounts'
    }) as string[]
    setAccount(accounts[0])
    setSelected(provider)
  }, [])

  if (account && selected) {
    return (
      <div>
        <img src={selected.info.icon} alt={selected.info.name} />
        <p>{selected.info.name}</p>
        <p>{account.slice(0, 6)}...{account.slice(-4)}</p>
      </div>
    )
  }

  return (
    <div>
      <h2>Select Wallet</h2>
      {providers.map(p => (
        <button key={p.info.uuid} onClick={() => connect(p)}>
          <img src={p.info.icon} alt={p.info.name} />
          {p.info.name}
        </button>
      ))}
    </div>
  )
}
```

---

<Callout type="success" title="文档规划完成">
  本规划文档已完成。可以基于此结构开始编写各章节内容，使用 DocComponents 组件库构建视觉化的开发者文档。
</Callout>
